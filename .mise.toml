[tools]
jq = "latest"
# note: rust-toolchain.toml is an 'idiomatic version file' for rust and mise does
#       pick it up automatically, but it is currently behind a experimental flag
rust = "{{ exec(command='./scripts/rust-version.sh') }}"
cargo-binstall = "latest"
"cargo:bacon" = "latest"

# once progenitor releases a new version, we can depend on that
"cargo:https://github.com/oxidecomputer/progenitor" = {version = "branch:update-typify", crate = "cargo-progenitor"}

[hooks]
postinstall = "rustup component add clippy"

[env]
_.file = ['.env', '.env.local']

# Privy credentials for running examples
# You can set these values here, or in a .env.local file that mise will load.
# PRIVY_APP_ID = ""
# PRIVY_APP_SECRET = ""

[tasks.pull-openapi]
description = "Pull the latest OpenAPI spec from the Privy API repo and apply our overlay"
run = """
#!/usr/bin/env bash
set -euo pipefail

# Pull the official Privy OpenAPI spec and apply a series of patches to make it work
# with progenitor code generation. Each patch is documented in scripts/schema-patches/
#
# Pipeline:
# 1. Fetch base spec from Privy API
# 2. Apply schema patches in sequence (01-09)
# 3. Output final processed spec to openapi.json
#
# The patches handle:
# - Fixing schema issues (duplicates, missing fields)
# - Adding operationIds to legacy endpoints
# - Removing deprecated endpoints
# - Converting anyOf to oneOf for better type discrimination
# - Cleaning up parameter definitions

curl -s https://api.privy.io/v1/openapi.json \
  | jq -f scripts/schema-patches/01-operation-ids.jq \
  | jq -f scripts/schema-patches/02-owner-input.jq \
  | jq -f scripts/schema-patches/03-solana-wallet-required-fields.jq \
  | jq -f scripts/schema-patches/04-remove-privy-app-id-param.jq \
  | jq -f scripts/schema-patches/05-remove-deprecated.jq \
  | jq -f scripts/schema-patches/06-remove-additional-properties.jq \
  | jq -f scripts/schema-patches/07-anyof-to-oneof.jq \
  | jq -f scripts/schema-patches/08-coinbase-onramp-assets.jq \
  | jq -f scripts/schema-patches/09-deduplicate-enums.jq \
  | jq -f scripts/schema-patches/10-kraken-multipart.jq \
  | jq -f scripts/schema-patches/11-deduplicate-properties.jq \
  | jq -f scripts/schema-patches/12-remove-custom-oauth.jq \
  > openapi.json
"""

[tasks.gen-openapi]
description = "Generate the Rust code for the Privy API"
depends = ["pull-openapi"]
run = """
#!/usr/bin/env bash

# get current crate version
VERSION=$(grep -m 1 "^version" crates/privy-openapi/Cargo.toml | cut -d '"' -f 2)
cargo-progenitor progenitor --input openapi.json --name privy-openapi -o crates/privy-openapi --version $VERSION --license-name "MIT OR Apache-2.0"
# insert description using sed
sed -i '2i description="Privy OpenAPI Bindings"' crates/privy-openapi/Cargo.toml
"""

[tasks.gen-p256-key]
description = "Generate P-256 key pair for Privy wallet owner"
run = [
  "openssl ecparam -genkey -name prime256v1 -noout -out private_key.pem",
  "openssl ec -in private_key.pem -pubout -out public_key.pem",
  "echo 'Generated P-256 key pair:'",
  "echo 'Private key: private_key.pem'",
  "echo 'Public key: public_key.pem'",
  "echo",
  "echo 'Public key contents:'",
  "cat public_key.pem"
]
